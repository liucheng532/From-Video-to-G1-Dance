# RoboMimicDeploy_G1_Kboard 操作指南

## 项目概述

本项目是基于FSM状态机的G1机器人控制系统，支持多种运动模式，包括运动跟踪、舞蹈、技能表演等功能。

## 系统架构优化

### 已实施的优化

1. **策略缓存优化**：使用映射表替代长if-elif链，提高策略查找效率
2. **MotionTracking计算优化**：
   - 预分配数组，避免重复创建
   - 预计算关节索引映射，减少查找时间
   - 优化四元数和矩阵运算
3. **安全保护机制**：
   - 计算时间监控
   - 紧急停止保护
   - 信号丢失保护

## 支持的运动模式

### 1. 阻尼保护模式 (PASSIVE)
- **触发方式**：按下F1键
- **功能**：机器人进入阻尼模式，所有关节处于低刚度状态
- **用途**：安全保护，防止意外伤害

### 2. 位置重置模式 (FIXEDPOSE)
- **触发方式**：按下START键
- **功能**：机器人回到预设的固定姿态
- **用途**：初始化或重置机器人姿态

### 3. 运动模式 (LOCOMODE)
- **触发方式**：R1 + A
- **功能**：机器人进入运动模式，支持行走和转向
- **控制**：
  - 左摇杆：前后左右移动
  - 右摇杆：转向

### 4. 舞蹈模式 (DANCE)
- **触发方式**：R1 + Y
- **功能**：执行预设的舞蹈动作序列
- **特点**：自动播放，无需额外控制

### 5. 技能表演模式 (SKILL_CAST)
- **触发方式**：R1 + X
- **功能**：执行技能表演动作
- **特点**：展示机器人的特殊技能

### 6. 技能冷却模式 (SKILL_COOLDOWN)
- **触发方式**：自动触发
- **功能**：技能执行后的冷却状态
- **特点**：防止连续执行技能造成过载

### 7. 站立模式 (STANDMODE)
- **触发方式**：自动触发
- **功能**：保持稳定站立姿态
- **特点**：平衡控制，防止摔倒

### 8. 运动跟踪模式 (MOTION_TRACKING) ⭐
- **触发方式**：R1 + B
- **功能**：跟踪预录制的运动序列
- **特点**：
  - 高精度运动复现
  - 实时性能监控
  - 安全保护机制

## 安全保护机制

### MotionTracking模式安全保护

1. **计算时间监控**：
   - 最大计算时间限制：15ms
   - 超过限制时自动触发紧急停止
   - 使用上一个有效动作保持稳定

2. **紧急停止机制**：
   - 检测到超时时立即停止新动作计算
   - 保持当前姿态，防止"疯机"
   - 连续3次正常计算后自动解除紧急停止

3. **性能监控**：
   - 实时显示计算时间统计
   - 平均、最大、最小计算时间
   - 紧急停止状态指示

## 操作流程

### 启动流程

1. **系统初始化**：
   ```bash
   python deploy_real/deploy_real.py
   ```

2. **等待连接**：
   - 系统自动连接到机器人
   - 显示"Successfully connected to the robot."

3. **进入阻尼模式**：
   - 系统默认进入阻尼保护模式
   - 按下START键进入位置重置

### 模式切换

1. **从阻尼模式开始**：
   - 按下START键 → 位置重置模式
   - 按下F1键 → 保持阻尼模式

2. **正常操作模式**：
   - R1 + A → 运动模式
   - R1 + B → 运动跟踪模式
   - R1 + X → 技能表演模式
   - R1 + Y → 舞蹈模式

3. **安全退出**：
   - 按下SELECT键 → 安全退出系统

## 性能监控

### 实时监控信息

系统会显示以下性能信息：

1. **控制循环时间**：
   - 正常：< 20ms
   - 警告：> 20ms时显示"control loop over time"

2. **MotionTracking性能**（每100步显示一次）：
   - 平均计算时间
   - 最大计算时间
   - 当前计算时间
   - 紧急停止状态

### 性能优化建议

1. **系统要求**：
   - 确保系统有足够的CPU资源
   - 关闭不必要的后台程序
   - 使用实时优先级运行

2. **网络要求**：
   - 确保DDS通信稳定
   - 检查网络接口配置
   - 避免网络拥塞

## 故障排除

### 常见问题

1. **"control loop over time"警告**：
   - 原因：计算时间超过20ms
   - 解决：检查系统负载，优化计算

2. **MotionTracking紧急停止**：
   - 原因：计算时间超过15ms
   - 解决：系统自动保护，等待计算恢复正常

3. **机器人"疯机"现象**：
   - 原因：计算超时或通信中断
   - 解决：安全保护机制自动激活，保持稳定姿态

4. **连接失败**：
   - 原因：网络配置或机器人未启动
   - 解决：检查网络接口和机器人状态

### 安全建议

1. **操作前检查**：
   - 确保机器人周围有足够空间
   - 检查所有连接线缆
   - 确认安全停止按钮可用

2. **操作中注意**：
   - 密切观察机器人状态
   - 发现异常立即按下安全停止
   - 不要离开机器人太远

3. **紧急情况**：
   - 立即按下机器人上的紧急停止按钮
   - 或按下遥控器上的SELECT键退出程序
   - 必要时切断电源

## 配置文件说明

### 主要配置文件

1. **deploy_real/config/real.yaml**：
   - 网络接口配置
   - 控制参数设置
   - 超时阈值配置

2. **policy/montion_tracking/config/Motion.yaml**：
   - MotionTracking模式配置
   - 模型文件路径
   - 动作数据路径

### 重要参数

- `control_dt: 0.02`：控制周期（20ms）
- `error_over_time: 5`：超时错误阈值
- `max_compute_time: 0.015`：MotionTracking最大计算时间（15ms）

## 更新日志

### v2.0 优化版本

1. **性能优化**：
   - 策略缓存优化，提高查找效率
   - MotionTracking计算优化，减少计算时间
   - 预分配数组，避免内存分配开销

2. **安全保护**：
   - 添加计算时间监控
   - 实现紧急停止机制
   - 防止"疯机"现象

3. **代码清理**：
   - 删除不需要的策略模式
   - 简化FSM架构
   - 提高代码可维护性

## 技术支持

如遇到问题，请检查：

1. 系统日志输出
2. 性能监控信息
3. 网络连接状态
4. 机器人硬件状态

---

**注意**：本系统包含安全保护机制，但仍需谨慎操作。操作前请确保充分了解系统功能和潜在风险。

# 模式切换逻辑图

## 按键映射表

| 按键组合 | FSMCommand | 目标状态 | 说明 |
|---------|------------|----------|------|
| F1 | PASSIVE | PASSIVE | 阻尼保护模式 |
| START | POS_RESET | FIXEDPOSE | 位置重置模式 |
| L1+X | STAND_UP | STANDMODE | 站立模式 |
| R1+A | LOCO | LOCOMODE | 运动模式 |
| R1+X | SKILL_1 | SKILL_CAST | 技能表演模式 |
| R1+Y | SKILL_2 | SKILL_Dance | 舞蹈模式 |
| R1+B | MOTION_TRACKING | SKILL_MotionTracking | 运动跟踪模式 |
| SELECT | - | 退出程序 | 安全退出 |

## 状态切换逻辑

### 1. PASSIVE (阻尼保护模式)
- **进入条件**: F1键 或 其他模式的安全退出
- **退出条件**: 
  - START键 → FIXEDPOSE
  - 其他情况 → 保持PASSIVE

### 2. FIXEDPOSE (位置重置模式)
- **进入条件**: START键
- **退出条件**: 
  - 自动完成 → LOCOMODE
  - PASSIVE命令 → PASSIVE

### 3. LOCOMODE (运动模式)
- **进入条件**: R1+A 或 其他模式完成后的默认状态
- **退出条件**:
  - R1+X (SKILL_1) → SKILL_CAST
  - R1+Y (SKILL_2) → SKILL_Dance
  - R1+B (MOTION_TRACKING) → SKILL_MotionTracking
  - F1 (PASSIVE) → PASSIVE
  - 其他情况 → 保持LOCOMODE

### 4. SKILL_CAST (技能表演模式)
- **进入条件**: R1+X
- **退出条件**:
  - 动作完成 → SKILL_COOLDOWN
  - F1 (PASSIVE) → PASSIVE
  - 其他情况 → 保持SKILL_CAST

### 5. SKILL_Dance (舞蹈模式)
- **进入条件**: R1+Y
- **退出条件**:
  - 动作完成 → SKILL_COOLDOWN
  - R1+A (LOCO) → SKILL_COOLDOWN
  - F1 (PASSIVE) → PASSIVE
  - START (POS_RESET) → FIXEDPOSE
  - 其他情况 → 保持SKILL_Dance

### 6. SKILL_MotionTracking (运动跟踪模式)
- **进入条件**: R1+B
- **退出条件**:
  - 动作完成 → SKILL_COOLDOWN
  - R1+A (LOCO) → SKILL_COOLDOWN
  - F1 (PASSIVE) → PASSIVE
  - 其他情况 → 保持SKILL_MotionTracking

### 7. SKILL_COOLDOWN (技能冷却模式)
- **进入条件**: 技能模式完成后的自动切换
- **退出条件**:
  - 冷却完成 → LOCOMODE
  - F1 (PASSIVE) → PASSIVE
  - 其他情况 → 保持SKILL_COOLDOWN

### 8. STANDMODE (站立模式)
- **进入条件**: L1+X
- **退出条件**:
  - R1+A (LOCO) → SKILL_COOLDOWN
  - F1 (PASSIVE) → PASSIVE
  - START (POS_RESET) → FIXEDPOSE
  - 其他情况 → 保持STANDMODE

## 安全保护机制

### MotionTracking模式特殊保护
1. **计算时间监控**: 超过15ms自动触发紧急停止
2. **紧急停止**: 使用上一个有效动作，保持稳定
3. **自动恢复**: 连续3次正常计算后解除紧急停止
4. **性能监控**: 实时显示计算时间统计

### 通用安全机制
1. **F1键**: 任何模式下都可以立即切换到安全模式
2. **SELECT键**: 安全退出程序
3. **超时保护**: 控制循环超时检测
4. **状态验证**: 未知状态时保持当前状态

## 状态切换流程图

```
启动 → PASSIVE
  ↓ (START)
FIXEDPOSE → LOCOMODE
  ↓ (R1+X)    ↓ (R1+Y)    ↓ (R1+B)
SKILL_CAST  SKILL_Dance  SKILL_MotionTracking
  ↓ (完成)     ↓ (完成)     ↓ (完成)
SKILL_COOLDOWN → LOCOMODE
  ↓ (F1)      ↓ (F1)      ↓ (F1)
PASSIVE ← ← ← ← ← ← ← ← ← ←
```

## 验证检查点

✅ **按键映射正确**: 所有按键组合都有对应的处理
✅ **状态切换完整**: 每个状态都有明确的进入和退出条件
✅ **安全保护到位**: F1键可以随时切换到安全模式
✅ **循环闭合**: 所有状态切换都能形成完整的循环
✅ **异常处理**: 未知状态时保持当前状态，不会崩溃
✅ **MotionTracking保护**: 有专门的安全保护机制防止疯机
